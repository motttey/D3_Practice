<!DOCTYPE html>
<html lang="en">
   <head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="js/contour.js"></script>
    <meta charset="utf-8"/>
    <title>D3 Interactive Map</title>
  </head>
  <body>
    <h1>D3 Interactive Map</h1>
    <div id="map_div">
      <svg id="map"></svg>
    </div>
    <div id="bar_chart_div">
      <svg id="bar_chart"></svg>
    </div>
  </body>

  <style>

  .line {
    fill: none;
    stroke: #000;
    stroke-width: 1.5px;
    stroke-linejoin: round;
    stroke-linecap: round;
  }

  </style>

  <script>
    const width = 800;
    const height = 600;
    const centerPos = [137.0, 38.2]; // 地図のセンター位置
    const scale = 1000; // 地図のスケール

    // 地図の投影設定
    const projection = d3
      .geoMercator()
      .center(centerPos)
      .translate([width / 2, height / 2])
      .scale(scale);

    // 地図をpathに投影(変換)
    const path = d3.geoPath().projection(projection);

    // SVG要素を追加
    const svg = d3
      .select("#map_div")
      .append("svg")
      .attr("viewBox", "0 0 " + width  + " " + height)
      .attr("width", "100%")
      .attr("height", "100%")
      .attr("class", "map");

    let render_line = d3.line().x(function(d) {
        return d[0];
      }).y(function(d) {
        return d[1];
      });

    let active_line = null;
    let lines_layer =
      svg.call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended));

    const data = Array.from(Array(47), (v, k) => Math.random())
    d3.json("json/japan.geojson").then(function(json) {
      console.log(json);
      svg.selectAll("path")
        .data(json.features)
        .enter()
        .append("path")
        .attr("d", path)
        .style("stroke", "gray")
        .style("stroke-width", 0.25)
        .style("fill", "blue")
        .style("opacity", function(d, i){
          return data[i];
        });
    });

    function dragstarted() {
      activeLine = svg.append("path").datum([]).attr("class", "line");
      activeLine.datum().push(d3.mouse(this));
    }

    function dragged() {
      activeLine.datum().push(d3.mouse(this));
      activeLine.attr("d", render_line);
    }

    function dragended() {
      activeLine = null;
      d3.selectAll(".line").remove();
    }
  </script>
</html>
