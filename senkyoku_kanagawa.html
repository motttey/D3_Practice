<!DOCTYPE html>
<html lang="en">
   <head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <meta charset="utf-8"/>
    <title>D3 Interactive Map</title>
  </head>
  <body>
    <div id="map_div">
      <svg id="map"></svg>
    </div>
    <div id="bar_chart_div">
      <svg id="bar_chart"></svg>
    </div>
  </body>

  <style>
  .line {
    fill: none;
    stroke: #000;
    stroke-width: 1.5px;
    stroke-linejoin: round;
    stroke-linecap: round;
  }

  </style>

  <script>
    const width = 900;
    const height = 600;
    const bar_height = 400;

    const centerPos = [137.0, 36.0]; // 地図のセンター位置
    const scale = 1300; // 地図のスケール

    const data = Array.from(Array(47), (v, k) => Math.random(1));
    const margin = 50;
    const duration = 1000;

    // 地図の投影設定
    const projection = d3
      .geoMercator()
      .center(centerPos)
      .translate([width / 2, height / 2])
      .scale(scale);

    // 地図をpathに投影(変換)
    const path = d3.geoPath().projection(projection);

    // SVG要素を追加
    const svg = d3
      .select("#map_div")
      .select("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("class", "map");

    setUpData();

    async function setUpData() {
      const map = await d3.json("https://raw.githubusercontent.com/amay077/senkyoku289/master/senkyoku289polygon.geojson");
      // map.features.sort((a, b) => a.properties.id - b.properties.id);
      console.log(map.features);

      const senkyo = await d3.csv("csv/hr96-17.csv");
      const senkyo_2017 = senkyo.filter((d) => d.year == "2017");
      console.log(senkyo_2017);

      svg.selectAll("path")
        .data(map.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("class", "pref")
        .style("stroke", "gray")
        .style("stroke-width", 0.25)
        .style("fill", (d, i) => {
          const pref_name = d.properties.kuname.split(new RegExp('[0-9]'))[0];
          const first_cand = senkyo_2017
            .filter((c) => c.pref ===  pref_name && c.kun == d.properties.ku.toString())
            .reduce((a, b) => parseInt(a.rank) < parseInt(b.rank)? a: b);

          console.log(first_cand.seito.includes("自民"));
          return (first_cand.seito.includes("自民"))? "salmon": "gray";
        });
    }
  </script>
</html>
